<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 5 Login</title>
    <link href="styles.css" rel="stylesheet">
    <style>
        .brand-text {
            background: linear-gradient(90deg, 
                #ffffff 0%, 
                #9ca3af 25%, 
                #ffffff 50%, 
                #9ca3af 75%, 
                #ffffff 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shine 3s linear infinite;
            font-size: 20px;
        }
        
        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
        
        .menu-icon {
            cursor: pointer;
            width: 36px;
            height: 36px;
            border: 3px solid #30363d;
        }
        
        .menu-icon:hover {
            border-color: #58a6ff;
        }
        
        .avatar-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .avatar-circle:hover {
            transform: scale(1.05);
        }
        
        .search-bar {
            width: 180px;
            transition: width 0.3s ease;
            background-color: #0d1117;
            border: 3px solid #30363d;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            outline: none;
            font-size: 13px;
        }
        
        .search-bar:focus {
            width: 320px;
            border-color: #58a6ff;
        }
        
        .search-bar::placeholder {
            color: #8b949e;
            font-size: 13px;
        }
        
        .copilot-button {
            position: relative;
            background-color: #0d1117;
            border: 3px solid #30363d;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copilot-button:hover {
            border-color: #58a6ff;
        }
        
        .copilot-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            margin-top: 8px;
            background-color: #010409;
            border: 3px solid #30363d;
            border-radius: 6px;
            padding: 10px 14px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .copilot-button:hover .copilot-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .copilot-tooltip-text {
            color: #8b949e;
            font-size: 13px;
        }
        
        /* Hidden Menu Styles */
        .hidden-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background-color: #0d1117;
            z-index: 2000;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.5);
        }
        
        .hidden-menu.active {
            left: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }
        
        .menu-brand {
            background: linear-gradient(90deg, 
                #ffffff 0%, 
                #9ca3af 25%, 
                #ffffff 50%, 
                #9ca3af 75%, 
                #ffffff 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shine 3s linear infinite;
            font-size: 16px;
            font-weight: bold;
        }
        
        .close-icon {
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .close-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-items {
            padding: 20px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            color: #c9d1d9;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-left-color: #58a6ff;
            color: #ffffff;
        }
        
        .menu-item.active {
            background-color: rgba(88, 166, 255, 0.1);
            border-left-color: #58a6ff;
            color: #58a6ff;
        }
    </style>
</head>
<body style="background-color: #0d1117;">
    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Hidden Menu -->
    <div class="hidden-menu" id="hiddenMenu">
        <!-- Menu Header -->
        <div class="menu-header">
            <div class="menu-brand">NEUROVIA</div>
            <div class="close-icon" id="closeMenuBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        
        <!-- Menu Items -->
        <div class="menu-items">
            <div class="menu-item active" data-page="home" onclick="window.location.href='/'">
                <span>Home</span>
            </div>
            <div class="menu-item" data-page="glm" onclick="window.location.href='/glm'">
                <span>GEO LEAD MAPPING</span>
            </div>
            <div class="menu-item" data-page="team-leads" onclick="window.location.href='/team-leads'">
                <span>Team Leads</span>
            </div>
            <div class="menu-item" data-page="project-6" onclick="window.location.href='/project-6'">
                <span>Project-6</span>
            </div>
            <div class="menu-item" data-page="database" onclick="window.location.href='/database'">
                <span>Database</span>
            </div>
            <div class="menu-item" data-page="stammdaten" onclick="window.location.href='/stammdaten'">
                <span>Stammdaten</span>
            </div>
            <div class="menu-item" data-page="settings">
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 w-full flex items-center justify-between px-6 py-4" style="background-color: #010409; z-index: 1000;">
        <!-- Left Side -->
        <div class="flex items-center">
            <!-- Menu Icon -->
            <button class="menu-icon flex items-center justify-center rounded-md transition-colors" id="menuBtn">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="3" y1="5" x2="17" y2="5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="3" y1="10" x2="17" y2="10" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="3" y1="15" x2="17" y2="15" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
            
            <!-- Brand Name -->
            <h1 class="brand-text ml-4 font-bold">NEUROVIA</h1>
        </div>
        
        <!-- Right Side -->
        <div class="flex items-center gap-3">
            <!-- Co-Pilot Button -->
            <div class="copilot-button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z" fill="white"/>
                    <path d="M19 4L20 7L23 8L20 9L19 12L18 9L15 8L18 7L19 4Z" fill="white"/>
                </svg>
                <div class="copilot-tooltip">
                    <span class="copilot-tooltip-text">Co-Pilot AI Function soon available</span>
                </div>
            </div>
            
            <!-- Search Bar -->
            <input 
                type="text" 
                class="search-bar" 
                placeholder="Type / to search"
            />
            
            <!-- Avatar Circle -->
            <div class="avatar-circle"></div>
        </div>
    </nav>
    
    <div class="min-h-screen flex flex-col items-center justify-center p-4" style="padding-top: 80px;">
        <!-- Suchen Button (versteckt, aber im Code) -->
        <button 
            id="searchButton" 
            style="display: none;"
            class="bg-white hover:bg-gray-100 text-black font-medium py-2 px-6 border border-black rounded-md transition duration-200 ease-in-out hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
            Suchen
        </button>
        
        <!-- Lead Repository Bereich -->
        <div style="position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 50%;">
            <!-- Statistik-Leiste -->
            <div style="
                width: 100%;
                background-color: #010409;
                border: 2px solid #30363d;
                border-radius: 8px;
                padding: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: stretch;
                gap: 1rem;
            ">
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    background-color: #24e39a;
                    padding: 0.75rem 1rem;
                    border-radius: 6px;
                ">
                    <div style="font-size: 1rem; color: #0d1117; font-weight: 600;">Leads: 127</div>
                </div>
                
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    background-color: #67e065;
                    padding: 0.75rem 1rem;
                    border-radius: 6px;
                ">
                    <div style="font-size: 1rem; color: #0d1117; font-weight: 600;">Team Leads: 45</div>
                </div>
                
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    background-color: #e4f266;
                    padding: 0.75rem 1rem;
                    border-radius: 6px;
                ">
                    <div style="font-size: 1rem; color: #0d1117; font-weight: 600;">E-Formulare: 89</div>
                </div>
                
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    background-color: #e61573;
                    padding: 0.75rem 1rem;
                    border-radius: 6px;
                ">
                    <div style="font-size: 1rem; color: white; font-weight: 600;">BK-Formulare: 34</div>
                </div>
                
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    background-color: #37c2f0;
                    padding: 0.75rem 1rem;
                    border-radius: 6px;
                ">
                    <div style="font-size: 1rem; color: #0d1117; font-weight: 600;">QC: 12</div>
                </div>
            </div>
            
            <!-- Analytics Counter -->
            <div style="
                width: 100%;
                background-color: #010409;
                border: 2px solid #30363d;
                border-radius: 8px;
                margin-top: 1rem;
                overflow: hidden;
            ">
                <!-- Navbar Header -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid #30363d;
                    background-color: transparent;
                ">
                    <div style="font-size: 0.95rem; color: white; font-weight: 600;">
                        Analytics
                    </div>
                    <button 
                        id="reloadLeadsBtn"
                        style="
                            background: transparent;
                            border: none;
                            cursor: pointer;
                            padding: 0.25rem;
                            transition: transform 0.2s;
                            display: flex;
                            align-items: center;
                        "
                        onmouseover="this.style.transform='rotate(180deg)'"
                        onmouseout="this.style.transform='rotate(0deg)'"
                    >
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 10C21 10 18.995 7.26822 17.3662 5.63824C15.7373 4.00827 13.4864 3 11 3C6.02944 3 2 7.02944 2 12C2 16.9706 6.02944 21 11 21C15.1031 21 18.5649 18.2543 19.6482 14.5M21 10V4M21 10H15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Data Content -->
                <div style="padding: 0.75rem 1rem;">
                    <!-- Leads -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0;
                    ">
                        <span style="font-size: 0.875rem; color: #8b949e;">Leads</span>
                        <span id="totalLeadsCount" style="font-size: 0.875rem; color: white; font-weight: 600;">-</span>
                    </div>
                    
                    <!-- Quick Checks -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0;
                    ">
                        <span style="font-size: 0.875rem; color: #8b949e;">Quick Checks</span>
                        <span style="font-size: 0.875rem; color: white; font-weight: 600;">342</span>
                    </div>
                    
                    <!-- E Formulare -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0;
                    ">
                        <span style="font-size: 0.875rem; color: #8b949e;">E Formulare</span>
                        <span id="eFormulareCount" style="font-size: 0.875rem; color: white; font-weight: 600;">-</span>
                    </div>
                    
                    <!-- BK Formulare -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0;
                    ">
                        <span style="font-size: 0.875rem; color: #8b949e;">BK Formulare</span>
                        <button 
                            id="downloadBkBtn"
                            style="
                                background: transparent;
                                border: 1px solid #30363d;
                                color: white;
                                font-size: 0.75rem;
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: 600;
                            "
                            onmouseover="this.style.borderColor='#58a6ff'; this.style.color='#58a6ff'"
                            onmouseout="this.style.borderColor='#30363d'; this.style.color='white'"
                        >
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Message -->
        <div id="status" class="mt-4 text-center text-sm"></div>
        
        <!-- Results Display -->
        <div id="resultsDisplay" class="mt-4 flex flex-col items-center gap-4 hidden">
            <div class="flex gap-4 text-white">
                <div class="bg-gray-900 px-6 py-3 rounded-lg border border-gray-800">
                    <span class="text-gray-400 text-xs">Datensätze</span>
                    <div id="recordCount" class="text-2xl font-bold text-green-400 mt-1">0</div>
                </div>
                <div class="bg-gray-900 px-6 py-3 rounded-lg border border-gray-800">
                    <span class="text-gray-400 text-xs">Datengröße</span>
                    <div id="dataSize" class="text-2xl font-bold text-blue-400 mt-1">0,00 MB</div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="w-full max-w-md bg-gray-900 rounded-lg p-4 border border-gray-800">
                <label class="block text-gray-400 text-sm mb-2">Mitarbeiter filtern</label>
                <input 
                    type="text" 
                    id="mitarbeiterFilter" 
                    class="w-full bg-gray-800 text-white border border-gray-700 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                    placeholder="Mitarbeiter-Name eingeben..."
                />
                <div class="mt-4 space-y-3">
                    <!-- Formulare -->
                    <div class="text-center bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <span class="text-gray-400 text-xs">Formulare (gesamt)</span>
                        <div id="filteredCount" class="text-2xl font-bold text-purple-400 mt-1">0</div>
                    </div>
                    
                    <!-- Mitarbeiter Statistiken -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center bg-gray-800 rounded-lg p-2 border border-gray-700">
                            <span class="text-gray-400 text-xs">MA mit Formularen</span>
                            <div id="mitarbeiterFormulareCount" class="text-xl font-bold text-blue-400 mt-1">0</div>
                        </div>
                        <div class="text-center bg-gray-800 rounded-lg p-2 border border-gray-700">
                            <span class="text-gray-400 text-xs">MA mit Leads</span>
                            <div id="mitarbeiterLeadsCount" class="text-xl font-bold text-orange-400 mt-1">0</div>
                        </div>
                        <div class="text-center bg-gray-800 rounded-lg p-2 border border-gray-700">
                            <span class="text-gray-400 text-xs">MA-Formulare (echt)</span>
                            <div id="verifiedFormulareCount" class="text-xl font-bold text-green-400 mt-1">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- PDF Download Button -->
                <button 
                    id="downloadPdfButton" 
                    class="mt-4 w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-6 border border-gray-700 rounded-md transition duration-200 ease-in-out disabled:opacity-30 disabled:cursor-not-allowed"
                    disabled>
                    PDF herunterladen
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Menu Toggle Functionality
        const menuBtn = document.getElementById('menuBtn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const hiddenMenu = document.getElementById('hiddenMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuItems = document.querySelectorAll('.menu-item');
        
        function openMenu() {
            hiddenMenu.classList.add('active');
            menuOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMenu() {
            hiddenMenu.classList.remove('active');
            menuOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        menuBtn.addEventListener('click', openMenu);
        closeMenuBtn.addEventListener('click', closeMenu);
        menuOverlay.addEventListener('click', closeMenu);
        
        // Close menu with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && hiddenMenu.classList.contains('active')) {
                closeMenu();
            }
        });
        
        const socket = io();
        
        // Gesamt Leads Reload Button
        const reloadLeadsBtn = document.getElementById('reloadLeadsBtn');
        const totalLeadsCount = document.getElementById('totalLeadsCount');
        const eFormulareCount = document.getElementById('eFormulareCount');
        const downloadBkBtn = document.getElementById('downloadBkBtn');
        
        function loadTotalLeads() {
            console.log('[LEADS] Lade Gesamt-Leads aus DB...');
            totalLeadsCount.textContent = '...';
            totalLeadsCount.style.color = '#58a6ff';
            socket.emit('count-total-leads');
        }
        
        async function loadFormulareStats() {
            console.log('[FORMULARE] Lade Statistiken aus DB...');
            eFormulareCount.textContent = '...';
            
            try {
                const response = await fetch('/api/formulare/stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ socketId: socket.id })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[FORMULARE] Anzahl in DB:', result.totalFormulare);
                    eFormulareCount.textContent = result.totalFormulare.toLocaleString('de-DE');
                } else {
                    console.error('[FORMULARE] Fehler:', response.statusText);
                    eFormulareCount.textContent = 'Fehler';
                }
            } catch (error) {
                console.error('[FORMULARE] Fehler:', error);
                eFormulareCount.textContent = 'Fehler';
            }
        }
        
        async function downloadBkFormulare() {
            console.log('[BK-FORMULARE] Starte Download...');
            downloadBkBtn.textContent = '...';
            downloadBkBtn.disabled = true;
            
            try {
                const response = await fetch('/api/formulare/download-bk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ socketId: socket.id })
                });
                
                if (response.ok) {
                    // CSV-Datei herunterladen
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bk-formulare-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    console.log('[BK-FORMULARE] Download erfolgreich!');
                } else {
                    console.error('[BK-FORMULARE] Fehler:', response.statusText);
                }
            } catch (error) {
                console.error('[BK-FORMULARE] Fehler:', error);
            } finally {
                downloadBkBtn.textContent = 'Download';
                downloadBkBtn.disabled = false;
            }
        }
        
        reloadLeadsBtn.addEventListener('click', () => {
            loadTotalLeads();
            loadFormulareStats();
        });
        
        downloadBkBtn.addEventListener('click', downloadBkFormulare);
        
        socket.on('total-leads-status', (data) => {
            console.log('[LEADS] Status:', data.message);
            totalLeadsCount.textContent = data.message;
            totalLeadsCount.style.color = '#58a6ff';
        });
        
        socket.on('total-leads-result', (data) => {
            console.log('[LEADS] Ergebnis:', data);
            if (data.success) {
                totalLeadsCount.textContent = data.totalLeads.toLocaleString('de-DE');
                totalLeadsCount.style.color = 'white';
            } else {
                totalLeadsCount.textContent = 'Fehler';
                totalLeadsCount.style.color = '#ff3b3b';
            }
        });
        
        // Socket.io Events für Formulare-Download
        socket.on('formulare-download-status', (data) => {
            console.log('[FORMULARE] Status:', data.message);
        });
        
        socket.on('formulare-download-complete', (data) => {
            console.log('[FORMULARE] Gefunden:', data.count, 'Formulare');
        });
        
        socket.on('formulare-download-error', (data) => {
            console.error('[FORMULARE] Fehler:', data.error);
        });
        
        // Socket.io Events für BK-Formulare
        socket.on('bk-formulare-status', (data) => {
            console.log('[BK-FORMULARE] Status:', data.message);
            downloadBkBtn.textContent = data.message;
        });
        
        socket.on('bk-formulare-complete', (data) => {
            console.log('[BK-FORMULARE] Gefunden:', data.count, 'BK-Formulare');
            downloadBkBtn.textContent = 'Download';
        });
        
        socket.on('bk-formulare-error', (data) => {
            console.error('[BK-FORMULARE] Fehler:', data.error);
            downloadBkBtn.textContent = 'Fehler';
        });
        
        const searchButton = document.getElementById('searchButton');
        const statusDiv = document.getElementById('status');
        const resultsDisplay = document.getElementById('resultsDisplay');
        const recordCount = document.getElementById('recordCount');
        const dataSize = document.getElementById('dataSize');
        const mitarbeiterFilter = document.getElementById('mitarbeiterFilter');
        const filteredCount = document.getElementById('filteredCount');
        const mitarbeiterFormulareCount = document.getElementById('mitarbeiterFormulareCount');
        const mitarbeiterLeadsCount = document.getElementById('mitarbeiterLeadsCount');
        const verifiedFormulareCount = document.getElementById('verifiedFormulareCount');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        
        // Cache für gescrapte Daten
        let cachedData = [];
        let cachedMitarbeiter = [];
        let cachedVerifiedFormulareCount = 0;
        
        // Aktueller Filter-State
        let currentFilteredData = {
            name: '',
            directFormulare: [],
            unterstellteMitarbeiter: [],
            unterstellteFormulare: [],
            allFormulare: [],
            phoneData: []
        };
        
        // Debounce Timer
        let filterTimeout = null;
        let isFiltering = false;
        
        // Verifizierungs-Funktion
        async function verifyFormulare(mitarbeiter, filterName) {
            if (!mitarbeiter || mitarbeiter.length === 0) {
                verifiedFormulareCount.textContent = '0';
                
                // Rote Trennlinie
                if (socket && socket.connected) {
                    socket.emit('filter-complete', { 
                        name: filterName,
                        formulare: currentFilteredData.allFormulare.length,
                        mitarbeiterFormulare: currentFilteredData.unterstellteMitarbeiter.filter(ma => ma.hasFormulare).length,
                        mitarbeiterLeads: currentFilteredData.unterstellteMitarbeiter.filter(ma => ma.hasLeads).length
                    });
                }
                return;
            }
            
            const mitarbeiterIds = mitarbeiter.map(ma => ({
                id: ma.mitarbeiterId || ma.vcnr || ma.gpnr || ma.col_1,
                name: `${ma.vorname || ''} ${ma.name || ''}`.trim()
            })).filter(m => m.id);
            
            // Finde den Hauptmitarbeiter (den gefilterten) in den Daten
            const hauptMitarbeiter = cachedMitarbeiter.find(ma => {
                const fullName = `${ma.vorname || ''} ${ma.name || ''}`.toLowerCase();
                return fullName.includes(filterName.toLowerCase());
            });
            
            const hauptMitarbeiterId = hauptMitarbeiter ? {
                id: hauptMitarbeiter.mitarbeiterId || hauptMitarbeiter.vcnr || hauptMitarbeiter.gpnr || hauptMitarbeiter.col_1,
                name: `${hauptMitarbeiter.vorname || ''} ${hauptMitarbeiter.name || ''}`.trim()
            } : null;
            
            console.log('[VERIFY] Hauptmitarbeiter:', hauptMitarbeiterId);
            
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        mitarbeiterIds,
                        socketId: socket.id,
                        hauptMitarbeiterId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    verifiedFormulareCount.textContent = data.verifiedFormulareCount;
                    currentFilteredData.phoneData = data.phoneData || [];
                    
                    console.log('[VERIFY] Telefonnummern erhalten:', data.phoneData?.length || 0);
                }
                
            } catch (error) {
                console.error('[VERIFY] Fehler:', error);
                verifiedFormulareCount.textContent = 'Fehler';
            } finally {
                // Rote Trennlinie nach Verifizierung
                if (socket && socket.connected) {
                    socket.emit('filter-complete', { 
                        name: filterName,
                        formulare: currentFilteredData.allFormulare.length,
                        mitarbeiterFormulare: mitarbeiter.filter(ma => ma.hasFormulare).length,
                        mitarbeiterLeads: mitarbeiter.filter(ma => ma.hasLeads).length
                    });
                }
            }
        }
        
        // Socket.io Event Listeners
        socket.on('connect', () => {
            console.log('[SOCKET] Verbunden:', socket.id);
            loadTotalLeads();
            loadFormulareStats();
        });
        
        socket.on('verify-progress', (data) => {
            verifiedFormulareCount.textContent = data.totalFormulare + ' (läuft...)';
        });
        
        socket.on('scrape-status', (data) => {
            showStatus(data.message, 'info');
        });
        
        socket.on('scrape-complete', (data) => {
            // Daten im Cache speichern
            cachedData = data.data || [];
            cachedMitarbeiter = data.mitarbeiterData || [];
            
            console.log('[DEBUG] Socket empfangen - Formulare:', cachedData.length);
            console.log('[DEBUG] Socket empfangen - Mitarbeiter:', cachedMitarbeiter.length);
            
            recordCount.textContent = data.count;
            dataSize.textContent = data.size + ' MB';
            verifiedFormulareCount.textContent = cachedVerifiedFormulareCount;
            resultsDisplay.classList.remove('hidden');
            showStatus('Scraping erfolgreich abgeschlossen!', 'success');
            searchButton.disabled = false;
            searchButton.textContent = 'Suchen';
            
            // Filter zurücksetzen
            mitarbeiterFilter.value = '';
            filteredCount.textContent = data.count;
            mitarbeiterFormulareCount.textContent = '0';
            mitarbeiterLeadsCount.textContent = '0';
            downloadPdfButton.disabled = true;
            downloadPdfButton.classList.remove('bg-green-600', 'hover:bg-green-500', 'border-green-500');
            downloadPdfButton.classList.add('bg-gray-800', 'hover:bg-gray-700', 'border-gray-700');
        });
        
        socket.on('scrape-error', (data) => {
            showStatus('Fehler: ' + data.error, 'error');
            searchButton.disabled = false;
            searchButton.textContent = 'Suchen';
        });
        
        // Optimierte Filter-Funktion
        function performFilter(filterValue) {
            if (isFiltering) return;
            isFiltering = true;
            
            // Zeige Loading-Indikator
            filteredCount.textContent = '...';
            mitarbeiterFormulareCount.textContent = '...';
            mitarbeiterLeadsCount.textContent = '...';
            
            // Verwende setTimeout um UI-Thread nicht zu blockieren
            setTimeout(() => {
                try {
                    if (filterValue === '') {
                        filteredCount.textContent = cachedData.length;
                        mitarbeiterFormulareCount.textContent = '0';
                        mitarbeiterLeadsCount.textContent = '0';
                        downloadPdfButton.disabled = true;
                        downloadPdfButton.classList.remove('bg-green-600', 'hover:bg-green-500', 'border-green-500');
                        downloadPdfButton.classList.add('bg-gray-800', 'hover:bg-gray-700', 'border-gray-700');
                        currentFilteredData.name = '';
                        isFiltering = false;
                        return;
                    }
                    
                    const lowerFilterValue = filterValue.toLowerCase();
                    
                    // Filtere direkte Formulare
                    const directFormulare = [];
                    for (let i = 0; i < cachedData.length; i++) {
                        const mitarbeiter = (cachedData[i].mitarbeiter || '').toLowerCase();
                        if (mitarbeiter.includes(lowerFilterValue)) {
                            directFormulare.push(cachedData[i]);
                        }
                    }
                    
                    // Finde unterstellte Mitarbeiter
                    const unterstellteMitarbeiter = [];
                    const unterstellteNamenSet = new Set();
                    let mitarbeiterMitFormulare = 0;
                    let mitarbeiterMitLeads = 0;
                    
                    for (let i = 0; i < cachedMitarbeiter.length; i++) {
                        const ma = cachedMitarbeiter[i];
                        const fuehrungskraft = (ma.fuehrungskraft || '').toLowerCase();
                        const registrator = (ma.registrator || '').toLowerCase();
                        
                        if (fuehrungskraft.includes(lowerFilterValue) || registrator.includes(lowerFilterValue)) {
                            unterstellteMitarbeiter.push({
                                ...ma,
                                isFuehrungskraft: fuehrungskraft.includes(lowerFilterValue),
                                isRegistrator: registrator.includes(lowerFilterValue)
                            });
                            unterstellteNamenSet.add(`${ma.vorname || ''} ${ma.name || ''}`.toLowerCase().trim());
                            
                            // Zähle Aktionen
                            if (ma.hasFormulare) mitarbeiterMitFormulare++;
                            if (ma.hasLeads) mitarbeiterMitLeads++;
                        }
                    }
                    
                    // Finde Formulare der unterstellten Mitarbeiter
                    const unterstellteFormulare = [];
                    if (unterstellteNamenSet.size > 0) {
                        const unterstellteNamen = Array.from(unterstellteNamenSet);
                        for (let i = 0; i < cachedData.length; i++) {
                            const mitarbeiterName = (cachedData[i].mitarbeiter || '').toLowerCase().trim();
                            for (let j = 0; j < unterstellteNamen.length; j++) {
                                if (mitarbeiterName.includes(unterstellteNamen[j])) {
                                    unterstellteFormulare.push(cachedData[i]);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Alle Formulare dedupliziert
                    const allFormulareMap = new Map();
                    for (let i = 0; i < directFormulare.length; i++) {
                        allFormulareMap.set(directFormulare[i].id, directFormulare[i]);
                    }
                    for (let i = 0; i < unterstellteFormulare.length; i++) {
                        allFormulareMap.set(unterstellteFormulare[i].id, unterstellteFormulare[i]);
                    }
                    const allFormulare = Array.from(allFormulareMap.values());
                    
                    // Update UI
                    filteredCount.textContent = allFormulare.length;
                    mitarbeiterFormulareCount.textContent = mitarbeiterMitFormulare;
                    mitarbeiterLeadsCount.textContent = mitarbeiterMitLeads;
                    verifiedFormulareCount.textContent = '...';
                    
                    // Speichere gefilterte Daten
                    currentFilteredData = {
                        name: filterValue,
                        directFormulare,
                        unterstellteMitarbeiter,
                        unterstellteFormulare,
                        allFormulare
                    };
                    
                    // Aktiviere PDF-Button
                    downloadPdfButton.disabled = false;
                    downloadPdfButton.classList.remove('bg-gray-800', 'hover:bg-gray-700', 'border-gray-700');
                    downloadPdfButton.classList.add('bg-green-600', 'hover:bg-green-500', 'border-green-500');
                    
                    // Starte Verifizierung der Formulare
                    verifyFormulare(unterstellteMitarbeiter.filter(ma => ma.hasFormulare), filterValue);
                    
                } finally {
                    isFiltering = false;
                }
            }, 0);
        }
        
        // Mitarbeiter-Filter Event Listener mit Debouncing
        mitarbeiterFilter.addEventListener('input', (e) => {
            // Clear vorheriger Timer
            if (filterTimeout) {
                clearTimeout(filterTimeout);
            }
            
            const filterValue = e.target.value.trim();
            
            // Sofortiges Feedback bei leerem Feld
            if (filterValue === '') {
                performFilter('');
                return;
            }
            
            // Grüne Trennlinie im Terminal über Socket
            if (socket && socket.connected) {
                socket.emit('filter-start', { name: filterValue });
            }
            
            // Debounce: Warte 600ms nach letztem Tastendruck
            filterTimeout = setTimeout(() => {
                performFilter(filterValue);
            }, 600);
        });
        
        searchButton.addEventListener('click', async () => {
            // Button deaktivieren
            searchButton.disabled = true;
            searchButton.textContent = 'Wird verarbeitet...';
            showStatus('Starte Scraping...', 'info');
            resultsDisplay.classList.add('hidden');
            
            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ socketId: socket.id })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    showStatus('Fehler: ' + data.error, 'error');
                    searchButton.disabled = false;
                    searchButton.textContent = 'Suchen';
                } else {
                    // Daten auch hier cachen (Fallback)
                    cachedData = data.data || [];
                    cachedMitarbeiter = data.mitarbeiterData || [];
                    
                    console.log('[DEBUG] HTTP Response - Formulare:', cachedData.length);
                    console.log('[DEBUG] HTTP Response - Mitarbeiter:', cachedMitarbeiter.length);
                }
                
            } catch (error) {
                showStatus('Netzwerkfehler: ' + error.message, 'error');
                searchButton.disabled = false;
                searchButton.textContent = 'Suchen';
            }
        });
        
        // PDF Download Event Listener
        downloadPdfButton.addEventListener('click', async () => {
            if (!currentFilteredData.name) {
                showStatus('Bitte einen Mitarbeiter filtern', 'error');
                return;
            }
            
            console.log('[PDF] Sende Daten:', {
                name: currentFilteredData.name,
                directCount: currentFilteredData.directFormulare?.length || 0,
                unterstellteCount: currentFilteredData.unterstellteMitarbeiter?.length || 0,
                unterstellteFormsCount: currentFilteredData.unterstellteFormulare?.length || 0,
                allCount: currentFilteredData.allFormulare?.length || 0
            });
            
            downloadPdfButton.disabled = true;
            const originalText = downloadPdfButton.textContent;
            downloadPdfButton.textContent = 'PDF wird erstellt...';
            
            try {
                const response = await fetch('/api/pdf/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentFilteredData)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Mitarbeiter_${currentFilteredData.name.replace(/\s/g, '_')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showStatus('PDF erfolgreich heruntergeladen!', 'success');
                } else {
                    showStatus('Fehler beim Erstellen der PDF', 'error');
                }
                
            } catch (error) {
                showStatus('Fehler beim Download: ' + error.message, 'error');
            } finally {
                downloadPdfButton.disabled = false;
                downloadPdfButton.textContent = originalText;
            }
        });
        
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'mt-4 text-center text-sm ';
            
            if (type === 'success') {
                statusDiv.classList.add('text-green-400');
            } else if (type === 'error') {
                statusDiv.classList.add('text-red-400');
            } else {
                statusDiv.classList.add('text-blue-400');
            }
        }
    </script>
</body>
</html>

